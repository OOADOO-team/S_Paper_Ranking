var viz=viz||{};viz.dateTypes=["YYYY","dd-MM-YYYY","YYYY-MM-dd","MM-dd-YYYY","MM-YYYY","YYYY-MM","MM","dd-MM","dd"],viz.computed_variables=["viz.computed.frequency"],viz.Dataset=function(t){this._options=t,this.data=new Array,this.edges=null,this.header={names:[],types:[],ids:{},calculated:[],length:0,getId:function(t){return"string"==typeof t?this.ids[t]:t}},this.metrics={sums:[],mins:[],maxs:[],hasChanged:[],isInteger:[]},this._indices=[],this._indices_length=[],this.length=0},viz.Dataset.fn=viz.Dataset.prototype,viz.Dataset.fn.clone=function(){var t=new viz.Dataset;return t.data=this.data.slice(0),t.header={names:this.header.names.slice(0),types:this.header.types.slice(0),ids:JSON.parse(JSON.stringify(this.header.ids)),calculated:this.header.calculated.slice(0),length:this.length,getId:function(t){return"string"==typeof t?this.ids[t]:t}},t.metrics={sums:this.metrics.sums.slice(0),mins:this.metrics.mins.slice(0),maxs:this.metrics.maxs.slice(0),hasChanged:this.metrics.hasChanged.slice(0),isInteger:this.metrics.isInteger.slice(0)},t._indices=this._indices.slice(0),t._indices_length=this._indices_length.slice(0),t.length=this.length,t},viz.Dataset.fn.done=function(t){this._done=t;var e,i,s,a,h,n=this;return this._options.structure&&"graph"==this._options.structure?this._options.url?raceme.ajax({url:this._options.url,done:function(r){s=r.indexOf("*nodes"),h=r.indexOf("*edges"),s>-1&&h>s+7?(i=r.substring(s+7,h-1).trim(),a=r.substring(h+6).trim(),e=Papa.parse(i,{dynamicTyping:!0}),n.data=e.data,n.parse(),n.edges=new viz.Dataset({data:a,datatypes:n._options.datatypes}),n.edges.done(function(){this.initAsNetwork(n),t.call(n)})):console.log("Data format error")}}):this._options.data&&(s=this._options.data.indexOf("*nodes"),h=this._options.data.indexOf("*edges"),s>-1&&h>s+7?(i=this._options.data.substring(s+7,h-1).trim(),a=this._options.data.substring(h+6).trim(),e=Papa.parse(i,{dynamicTyping:!0}),n.data=e.data,n.parse(),n.edges=new viz.Dataset({data:a,datatypes:n._options.datatypes}),n.edges.done(function(){this.initAsNetwork(n),t.call(n)})):console.log("Data format error")):this._options.url?raceme.ajax({url:this._options.url,done:function(e){n._options.url=null,n._options.data=e.trim(),n.done(t)}}):this._options.data&&(e=Papa.parse(this._options.data,{dynamicTyping:!0,header:!1,skipEmptyLines:!0,newline:"\n"}),n.data=e.data,n.parse(),t.call(n)),this},viz.Dataset.fn.parse=function(){for(var t=0;t<this.data[0].length;t++)this.hasColumn(this.data[0][t]),-1!=viz.computed_variables.indexOf(this.data[0][t])&&console.log("Invalid variable name"),this.header.ids[this.data[0][t]]=t,this.header.names.push(this.data[0][t]),this.header.calculated.push(null);for(t=this.data[0].length,this.header.ids["viz.computed.frequency"]=t,this.header.names.push("viz.computed.frequency"),this.header.calculated.push(null),t++,this.data.shift(),this.header.length=this.header.names.length,this.length=this.data.length,t=0;t<this.header.length;t++){var e,i=this.header.names[t];if(this.data[0]){e=this.data[0][t];var s=1;if("string"==typeof e)for(;""==e&&s<this.length;)e=this.data[s][t],s++}else e="string";-1!=viz.computed_variables.indexOf(i)?this.header.types[t]="number":this._options.datatypes&&this._options.datatypes[i]?("string"!=this._options.datatypes[i]&&"number"!=this._options.datatypes[i]&&"boolean"!=this._options.datatypes[i]&&"geo.country"!=this._options.datatypes[i]&&"geo.latitude"!=this._options.datatypes[i]&&"geo.longitude"!=this._options.datatypes[i]&&-1==viz.dateTypes.indexOf(this._options.datatypes[i])&&(this._options.datatypes[i]="string"),this.header.types[t]=this._options.datatypes[i]):"string"==typeof e?this.header.types[t]="string":"number"==typeof e?this.header.types[t]="number":"boolean"==typeof e&&(this.header.types[t]="boolean")}this.eachRow(function(t,e){this.formatRow(e),this.indexRow(e)})},viz.Dataset.fn.addCalculatedVariable=function(t,e){if(this.hasColumn(this.data[0][o]))console.log("Variable duplicated.");else{var i=this.header.names.length,s="",a=[];if("frequency("==e.substr(0,10)&&e.length>11){var h=e.substr(10);h=h.substr(0,h.length-1),this.hasColumn(h)&&this.isCategorical(h)&&(s="frequency",a=[h])}if(""!=s){var n=this.header.getId(a[0]);this.header.ids[t]=i,this.header.names.push(t),this.header.calculated.push({formula:s,parameters:a}),this.header.types.push("number"),this.header.length++;for(var r=0,d=1,o=0;o<this.length;o++)"frequency"==s?(this.data[o][i]=1/this.rows(a[0],this.data[o][n]).length,r+=this.data[o][i],d=Math.min(this.data[o][i],d)):(this.data[o][i]=1,r++);r=Math.round(r),this.metrics.sums[i]=r,this.metrics.mins[i]=d,this.metrics.maxs[i]=1,this.metrics.hasChanged[i]=!1,this.metrics.isInteger[i]=!0}}},viz.Dataset.fn.isDateType=function(t){return-1!=viz.dateTypes.indexOf(this.columnType(t))?!0:!1},viz.Dataset.fn.isCategorical=function(t){return"number"==this.columnType(t)||"boolean"==this.columnType(t)||"geo.latitude"==this.columnType(t)||"geo.longitude"==this.columnType(t)?!1:!0},viz.Dataset.fn.hasColumn=function(t){return t=this.header.getId(t),"undefined"==typeof this.header.names[t]?!1:!0},viz.Dataset.fn.columnNames=function(){return this.header.names},viz.Dataset.fn.columnName=function(t){return t=this.header.getId(t),this.header.names[t]},viz.Dataset.fn.columnType=function(t){return t=this.header.getId(t),this.header.types[t]},viz.Dataset.fn.min=function(t){return"number"==this.columnType(t)||this.isDateType(t)||this.columnType("geo.latitude")||this.columnType("geo.longitude")?(t=this.header.getId(t),"boolean"==typeof this.metrics.hasChanged[t]&&1==this.metrics.hasChanged[t]&&this._calc_min_max(t),this.metrics.mins[t]):0},viz.Dataset.fn.max=function(t){return"number"==this.columnType(t)||this.isDateType(t)||this.columnType("geo.latitude")||this.columnType("geo.longitude")?(t=this.header.getId(t),"boolean"==typeof this.metrics.hasChanged[t]&&1==this.metrics.hasChanged[t]&&this._calc_min_max(t),this.metrics.maxs[t]):0},viz.Dataset.fn._calc_min_max=function(t){var e,i=t;if(this.metrics.mins[i]=null,this.metrics.maxs[i]=null,"number"==this.columnType(t)||this.columnType("geo.latitude")||this.columnType("geo.longitude"))for(e=0;e<this.length;e++)null===this.metrics.mins[i]?(this.metrics.mins[i]=this.data[e][i],this.metrics.maxs[i]=this.data[e][i]):this.data[e][i]<this.metrics.mins[i]?this.metrics.mins[i]=this.data[e][i]:this.data[e][i]>this.metrics.maxs[i]&&(this.metrics.maxs[i]=this.data[e][i]);else if(this.isDateType(t)){var s=this.header.types[i];for(e=0;e<this.length;e++){var a=this.data[e][i],h=viz.Utils.date(this.data[e][i],s);null===this.metrics.mins[i]?(this.metrics.mins[i]=a,this.metrics.maxs[i]=a):h<viz.Utils.date(this.metrics.mins[i],s)?this.metrics.mins[i]=a:h>viz.Utils.date(this.metrics.maxs[i],s)&&(this.metrics.maxs[i]=a)}}this.metrics.hasChanged[t]=!1},viz.Dataset.fn.isInteger=function(t){return t=this.header.getId(t),"boolean"==typeof this.metrics.isInteger[t]?this.metrics.isInteger[t]:!0},viz.Dataset.fn.sum=function(t){return t=this.header.getId(t),"number"==this.columnType(t)||this.columnType("geo.latitude")||this.columnType("geo.longitude")?this.metrics.sums[t]:this.row(0)[t]},viz.Dataset.fn.sums=function(){var t=new Array;for(i=0;i<this.header.length;i++)t[i]=this.sum(i);return t},viz.Dataset.fn.average=function(t,e){return"number"==this.columnType(t)||this.columnType("geo.latitude")||this.columnType("geo.longitude")?(t=this.header.getId(t),"number"==typeof e?viz.Utils.round(this.metrics.sums[t]/this.length,e):this.metrics.sums[t]/this.length):0},viz.Dataset.fn.add=function(t){return this.data.push(t),this.length++,this.formatRow(this.length-1),this.indexRow(this.length-1),this},viz.Dataset.fn.formatRow=function(t,e){var i=0,s=this.header.length-1;"undefined"!=typeof e&&(i=e,s=e);for(var a=i;s>=a;a++)if("string"==this.header.types[a]||"geo.country"==this.header.types[a])"string"!=typeof this.data[t][a]&&(this.data[t][a]=this.data[t][a].toString()),""==this.data[t][a]&&(this.data[t][a]="null");else if("number"==this.header.types[a]||"geo.latitude"==this.header.types[a]||"geo.longitude"==this.header.types[a])"string"==typeof this.data[t][a]&&(this.data[t][a]=parseFloat(this.data[t][a])),("undefined"==typeof this.data[t][a]||isNaN(this.data[t][a]))&&("viz.computed.frequency"==this.columnName(a)?this.data[t][a]=1:this.data[t][a]=0),"undefined"==typeof this.metrics.mins[a]?(this.metrics.mins[a]=this.data[t][a],this.metrics.maxs[a]=this.data[t][a],this.metrics.sums[a]=0):this.data[t][a]<this.metrics.mins[a]?this.metrics.mins[a]=this.data[t][a]:this.data[t][a]>this.metrics.maxs[a]&&(this.metrics.maxs[a]=this.data[t][a]),this.metrics.sums[a]+=this.data[t][a],this.isInteger(a)&&viz.Utils.decimals(this.data[t][a])>0&&(this.metrics.isInteger[a]=!1);else if(this.isDateType(a)){var h=this.header.types[a];"string"!=typeof this.data[t][a]&&(this.data[t][a]=this.data[t][a].toString());var n=viz.Utils.date(this.data[t][a],h);n===!1&&(n=new Date),this.data[t][a]=n.strformat(h),"undefined"==typeof this.metrics.mins[a]?(this.metrics.mins[a]=this.data[t][a],this.metrics.maxs[a]=this.data[t][a]):n<viz.Utils.date(this.metrics.mins[a],h)?this.metrics.mins[a]=this.data[t][a]:n>viz.Utils.date(this.metrics.maxs[a],h)&&(this.metrics.maxs[a]=this.data[t][a])}else"boolean"==this.header.types[a]&&"boolean"!=typeof this.data[t][a]&&(this.data[t][a]=!1)},viz.Dataset.fn.indexRow=function(t){for(var e=0;e<this.header.length;e++)if(this.isCategorical(e)){var i=this.data[t][e];"undefined"==typeof this._indices[e]&&(this._indices[e]=new Array,this._indices_length[e]=0),"undefined"==typeof this._indices[e][i]&&(this._indices[e][i]=new Array,this._indices_length[e]++),this._indices[e][i].push(t)}},viz.Dataset.fn.eachRow=function(t){for(var e=0;e<this.length;e++)t.call(this,this.row(e),e)},viz.Dataset.fn.eachRowOrdered=function(t,e,i){if("undefined"==typeof e||0==this.isCategorical(e))return this.eachRow(t);e=this.header.getId(e);for(var s=this.unique(e,i),a=0;a<s.length;a++)for(var h=0;h<this._indices[e][s[a]].length;h++){var n=this._indices[e][s[a]][h];t.call(this,this.row(n),n)}},viz.Dataset.fn.row=function(t){return this.data[t].slice(0)},viz.Dataset.fn.value=function(t,e,i){if(e=this.header.getId(e),"undefined"==typeof i)return this.row(t)[e];if(this.isCategorical(e)){var s=this._indices[e][this.row(t)[e]].indexOf(t);-1!=s&&this._indices[e][this.row(t)[e]].splice(s,1)}else this.metrics.sums[e]-=this.row(t)[e];this.metrics.hasChanged[e]=!0,this.formatRow(t,e)},viz.Dataset.fn.rows=function(t,e){if(this.isCategorical(t)){t=this.header.getId(t);var i=new viz.Dataset;if(i.header=this.header,"undefined"==typeof this._indices[t]||"undefined"==typeof this._indices[t][e])return i;for(var s=0;s<this._indices[t][e].length;s++)i.add(this.row(this._indices[t][e][s]));return i}return this.where(function(i,s){return i[t]==e?!0:!1})},viz.Dataset.fn.where=function(t,e){e="undefined"==typeof e||1==e?!0:!1;var i=new viz.Dataset;return i.header=this.header,this.eachRow(function(s,a){if(e){for(var h={},n=0;n<s.length;n++)h[this.header.names[n]]=s[n];t.call(this,h)&&i.add(s)}else t.call(this,s)&&i.add(s)}),i},viz.Dataset.fn.split=function(t){for(var e=new Array,i=this.unique(t),s=0;s<i.length;s++){var a=this.rows(t,i[s]);e.push(a)}return e},viz.Dataset.fn.getTicks=function(t,e){var i=new Array;if(this.isDateType(t))for(var s=this.columnType(t),a=viz.Utils.date(this.min(t),s),h=viz.Utils.date(this.max(t),s),n=new Date(a.valueOf());h>=n;)i.push(n.strformat(s)),"YYYY"==s?n.setFullYear(n.getFullYear()+1):"MM"==s||"MM-YYYY"==s||"YYYY-MM"==s?n.setMonth(n.getMonth()+1):n.setDate(n.getDate()+1);else this.isCategorical(t)&&(i=this.unique(t,e));return i},viz.Dataset.fn.column=function(t){t=this.header.getId(t);var e=new Array;return this.eachRow(function(i,s){e.push(i[t])}),e},viz.Dataset.fn.unique=function(t,e){t=this.header.getId(t);var i=[];if(this.isCategorical(t)){if("undefined"!=typeof e&&null!==e&&e.ordered_items.length>0){var s=[];i=this._keys(this._indices[t]);for(var a=0;a<e.ordered_items.length;a++)-1!=i.indexOf(e.ordered_items[a])&&s.push(e.ordered_items[a]);if(i.length>e.ordered_items.length)for(a=0;a<i.length;a++)-1==e.ordered_items.indexOf(i[a])&&s.push(i[a]);return s}return this._indices.length?this._keys(this._indices[t]):[]}for(var h=this.column(t),n=0;n<h.length;n++)-1==i.indexOf(h[n])&&i.push(h[n]);return i},viz.Dataset.fn.groupBy=function(t,e){e=e||{};var i=new viz.Dataset;i.header=this.header;var s;for(s=0;s<t.length;s++){if(0==this.isCategorical(t[s]))return i;if(this.length==this._indices_length[this.header.getId(t[s])])return this}var a={};if(1==t.length)a=this._indices[this.header.getId(t[0])];else{var h=0;for(s=0;s<this.length;s++){for(var n="_",r=0;r<t.length;r++)n+=this.value(s,t[r])+"_";"undefined"==typeof a[n]&&(a[n]=new Array,h++),a[n].push(s)}if(h==this.length)return this}for(s in a){var d=new viz.Dataset;d.header=this.header;for(var o=0;o<a[s].length;o++)d.add(this.row(a[s][o]));for(var u=new Array,l=0;l<this.header.length;l++)"number"==this.header.types[l]||"geo.latitude"==this.header.types[l]||"geo.longitude"==this.header.types[l]?this.header.calculated[l]?"frequency"==this.header.calculated[l].formula?u.push(d.unique(this.header.calculated[l].parameters[0]).length):u.push(1):e[this.header.names[l]]&&"average"==e[this.header.names[l]]?u.push(d.average(this.header.getId(l))):e[this.header.names[l]]&&"rounded average"==e[this.header.names[l]]?u.push(d.average(this.header.getId(l),2)):u.push(d.sum(this.header.getId(l))):u.push(d.value(0,this.header.getId(l)));i.add(u)}return i},viz.Dataset.fn.initAsNetwork=function(t){for(var e=-1,i=-1,s=0;s<this.header.names.length-1;s++)for(var a=s+1;a<this.header.names.length-1;a++)if(this.header.names[s]==this.header.names[a]&&-1!=t.header.names.indexOf(this.header.names[s])){e=s,i=a;break}if(-1!=e){this.linkmatrix={},this.source_link_var=e,this.target_link_var=i,this.graph_index_var=t.header.names.indexOf(this.header.names[e]);for(var h=0;h<this.length;h++){var n=this.data[h][e]+"",r=this.data[h][i]+"";this.linkmatrix[n]=this.linkmatrix[n]||{},this.linkmatrix[n][r]=this.linkmatrix[n][r]||{},this.linkmatrix[n][r].rows=this.linkmatrix[n][r].rows||[],this.linkmatrix[n][r].rows.push(h)}}else console.log("No link between nodes and edges found")},viz.Dataset.fn._isFunction=function(t){return"function"==typeof t},viz.Dataset.fn._keys=function(t){if(Object.keys)return Object.keys(t);keys=new Array;for(var e in t)keys.push(e);return keys};